\documentclass{beamer}
\usecolortheme{orchid}


\usepackage{capt-of}
\usepackage{placeins}
\usepackage[toc,page]{appendix}
\usepackage{multirow}
\usepackage{xspace}
\usepackage{latexsym}
\usepackage{amssymb}
\usepackage{listings}
\usepackage{tikz}
\usetikzlibrary{calc,shapes.callouts,shapes.arrows}

\usepackage{color}
\usepackage[T1]{fontenc}
\usepackage{pcallst}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}
\definecolor{orange}{rgb}{1.0,0.49,0.0}

\usepackage{pifont}

\lstset{frame=single,
  language={Java},
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  basicstyle={\tiny\ttfamily},
  numbers=left,
  stepnumber=1,
  numberstyle=\tiny\color{gray},
  commentstyle=\color{dkgreen},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=1,
  morecomment=[l]{\\*},
  morekeywords={}
}

\newcommand\tab[1][1cm]{\hspace*{#1}}
\renewcommand{\floatpagefraction}{.99}
\renewcommand{\textfraction}{.01}

\newcommand{\tlaplus}{TLA\textsuperscript{+}\xspace}
\newcommand{\EXCEPT}{\textsc{except}}
\newcommand{\IF}{\textsc{if}}
\newcommand{\THEN}{\textsc{then}}
\newcommand{\ELSE}{\textsc{else}}
\newcommand{\seq}[1]{\langle #1 \rangle}

\newcommand{\keyword}[1]{\textbf{#1}}
\newcommand{\entity}[1]{\ensuremath{\langle}#1\ensuremath{\rangle}}

% editorial comments in the text or in marginal notes
% 1st argument: initials of the person making the comment,
% 2nd argument: comment to insert
\long\def\ednote#1#2{\par\noindent\framebox{\begin{minipage}{0.99\linewidth}\linespread{.7}\footnotesize #1: #2\end{minipage}}\par}
\newcommand{\edmargin}[2]{\marginpar{\raggedright\linespread{.7}\footnotesize #1: #2}}

\newcommand{\arrowthis}[2]{
        \tikz[remember picture,baseline]{\node[anchor=base,inner sep=0,outer sep=0]%
        (#1) {\underline{#1}};
        \node[overlay,single arrow,draw=none,fill=red!50,anchor=tip,rotate=60] 
        at (#1.south) {#2};}%
    }%
    \newcommand{\speechthis}[2]{
        \tikz[remember picture,baseline]{\node[anchor=base,inner sep=0,outer sep=0]%
        (#1) {\underline{#1}};\node[overlay,ellipse callout,fill=blue!50] 
        at ($(#1.north)+(-.5cm,0.8cm)$) {#2};}%
    }%

\newcommand{\bubblethis}[2]{
        \tikz[remember picture,baseline]{\node[anchor=base,inner sep=0,outer sep=0]%
        (#1) {\underline{#1}};\node[overlay,cloud callout,callout relative pointer={(0.2cm,-0.7cm)},%
        aspect=2.5,fill=yellow!90] at ($(#1.north)+(-0.5cm,1.6cm)$) {#2};}%
    }%

\newcommand{\pointthis}[2]{
        \tikz[remember picture,baseline]{\node[anchor=base,inner sep=0,outer sep=0]%
        (#1) {\underline{#1}};\node[overlay,rectangle callout,%
        callout relative pointer={(0.2cm,0.7cm)},fill=green!50] at ($(#1.north)+(-.5cm,-1.4cm)$) {#2};}%
        }%

\pgfkeys{%
    /calloutquote/.cd,
    width/.code                   =  {\def\calloutquotewidth{#1}},
    position/.code                =  {\def\calloutquotepos{#1}}, 
    author/.code                  =  {\def\calloutquoteauthor{#1}},
    /calloutquote/.unknown/.code   =  {\let\searchname=\pgfkeyscurrentname
                                 \pgfkeysalso{\searchname/.try=#1,                                
    /tikz/\searchname/.retry=#1},\pgfkeysalso{\searchname/.try=#1,
                                  /pgf/\searchname/.retry=#1}}
                            }  


\newcommand\calloutquote[2][]{%
       \pgfkeys{/calloutquote/.cd,
         width               = 5cm,
         position            = {(0,-1)},
         author              = {}}
  \pgfqkeys{/calloutquote}{#1}                   
  \node [rectangle callout,callout relative pointer={\calloutquotepos},text width=\calloutquotewidth,/calloutquote/.cd,
     #1] (tmpcall) at (0,0) {#2};
  \node at (tmpcall.pointer){\calloutquoteauthor};    
}  

%% make TeX use text italic font in math environments
\makeatletter
\newcounter{abr@ctr}
\newcommand{\abr@c}{\c@abr@ctr\advance\c@abr@ctr\@ne}

\DeclareSymbolFont{tlaitalics}{\encodingdefault}{cmr}{m}{it}
\let\itfam\symtlaitalics

\newcommand{\noTeXmath}{%
\c@abr@ctr=\itfam
\multiply\c@abr@ctr"100\relax
\advance\c@abr@ctr "7061\relax
\mathcode`a=\abr@c\mathcode`b=\abr@c\mathcode`c=\abr@c\mathcode`d=\abr@c
\mathcode`e=\abr@c\mathcode`f=\abr@c\mathcode`g=\abr@c\mathcode`h=\abr@c
\mathcode`i=\abr@c\mathcode`j=\abr@c\mathcode`k=\abr@c\mathcode`l=\abr@c
\mathcode`m=\abr@c\mathcode`n=\abr@c\mathcode`o=\abr@c\mathcode`p=\abr@c
\mathcode`q=\abr@c\mathcode`r=\abr@c\mathcode`s=\abr@c\mathcode`t=\abr@c
\mathcode`u=\abr@c\mathcode`v=\abr@c\mathcode`w=\abr@c\mathcode`x=\abr@c
\mathcode`y=\abr@c\mathcode`z=\abr@c
\c@abr@ctr=\itfam
\multiply\c@abr@ctr"100\relax
\advance\c@abr@ctr "7041\relax
\mathcode`A=\abr@c\mathcode`B=\abr@c\mathcode`C=\abr@c\mathcode`D=\abr@c
\mathcode`E=\abr@c\mathcode`F=\abr@c\mathcode`G=\abr@c\mathcode`H=\abr@c
\mathcode`I=\abr@c\mathcode`J=\abr@c\mathcode`K=\abr@c\mathcode`L=\abr@c
\mathcode`M=\abr@c\mathcode`N=\abr@c\mathcode`O=\abr@c\mathcode`P=\abr@c
\mathcode`Q=\abr@c\mathcode`R=\abr@c\mathcode`S=\abr@c\mathcode`T=\abr@c
\mathcode`U=\abr@c\mathcode`V=\abr@c\mathcode`W=\abr@c\mathcode`X=\abr@c
\mathcode`Y=\abr@c\mathcode`Z=\abr@c}

\newcommand{\TeXmath}{%
\mathcode`a="7161\mathcode`b="7162\mathcode`c="7163\mathcode`d="7164%
\mathcode`e="7165\mathcode`f="7166\mathcode`g="7167\mathcode`h="7168%
\mathcode`i="7169\mathcode`j="716A\mathcode`k="716B\mathcode`l="716C%
\mathcode`m="716D\mathcode`n="716E\mathcode`o="716F\mathcode`p="7170%
\mathcode`q="7171\mathcode`r="7172\mathcode`s="7173\mathcode`t="7174%
\mathcode`u="7175\mathcode`v="7176\mathcode`w="7177\mathcode`x="7178%
\mathcode`y="7179\mathcode`z="717A\mathcode`A="7141\mathcode`B="7142%
\mathcode`C="7143\mathcode`D="7144\mathcode`E="7145\mathcode`F="7146%
\mathcode`G="7147\mathcode`H="7148\mathcode`I="7149\mathcode`J="714A%
\mathcode`K="714B\mathcode`L="714C\mathcode`M="714D\mathcode`N="714E%
\mathcode`O="714F\mathcode`P="7150\mathcode`Q="7151\mathcode`R="7152%
\mathcode`S="7153\mathcode`T="7154\mathcode`U="7155\mathcode`V="7156%
\mathcode`W="7157\mathcode`X="7158\mathcode`Y="7159\mathcode`Z="715A}

\tikzstyle{startstop} = [rectangle, rounded corners, minimum width=3cm, minimum height=1cm,text centered, draw=black, fill=red!30]

\tikzstyle{io} = [trapezium, trapezium left angle=70, trapezium right angle=110, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=blue!30]

\tikzstyle{process} = [rectangle, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=orange!30]

\tikzstyle{decision} = [diamond, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=green!30]

\tikzstyle{arrow} = [thick,->,>=stealth]

\noTeXmath
\makeatother

\makeatletter
\newcommand*{\centerfloat}{%
  \parindent \z@
  \leftskip \z@ \@plus 1fil \@minus \textwidth
  \rightskip\leftskip
  \parfillskip \z@skip}
\makeatother

\mode<presentation>
{
  \usetheme{default}      % or try Darmstadt, Madrid, Warsaw, ...
  \usecolortheme{default} % or try albatross, beaver, crane, ...
  \usefonttheme{default}  % or try serif, structurebold, ...
  \setbeamertemplate{navigation symbols}{}
  \setbeamertemplate{caption}[numbered]
} 
\setbeamertemplate{footline}[frame number]

\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

\title[Your Short Title]{An Extension of PlusCal for Modeling
Distributed Algorithms}
%\subtitle{Master of Computer Science - MFLS}
\institute{University of Lorraine, CNRS, Inria, Nancy, France}
\author[]{Heba Alkayed, Horatiu Cirstea, Stephan Merz}


%\date{6th July 2020}


\begin{document}

\begin{frame}
  \titlepage
\end{frame}

% Uncomment these lines for an automatically generated outline.
%\begin{frame}{Outline}
%  \tableofcontents
%\end{frame}

\section{Introduction}

\begin{frame}{Introduction}

\begin{block}{Formal Specification Languages}
\begin{itemize}

  \item Algorithms modeled using \tlaplus can be formally verified using the \tlaplus Toolbox
 \item PlusCal algorithms have a more familiar syntax and can be translated to \tlaplus 
\end{itemize}
\end{block}
\vskip 1cm

\end{frame}

\section{Distributed PlusCal}

\begin{frame}[fragile]{Distributed PlusCal Algorithms}

\begin{block}{Motivation}
An extension of PlusCal with a syntax that offers constructs for modeling distributed algorithms naturally
\end{block}

\begin{block}{Features}
\begin{itemize}
  \item Introduces
  \begin{itemize} 
        \item Sub-processes
        \item Communication channels
    \end{itemize}
  \item Can be translated into a TLA+ specification
\end{itemize}
\end{block}
\end{frame}

\begin{frame}[fragile]{Motivating example}

\begin{block}{Lamport Mutex Algorithm}
\begin{itemize}
  \item An algorithm for Mutual Exclusion in Distributed Systems
  \item Critical section requests are ordered based on timestamps
  \item Processes exchange 3 types of messages
  \begin{itemize} 
        \item Request
        \item Acknowledge
        \item Release
    \end{itemize}
   \item Processes need to asynchronously receive messages from each other
\end{itemize}
\end{block}
\end{frame}

\begin{frame}[fragile]{Process modelisation (in PlusCal)}
\begin{exampleblock}{Lamport Mutex Example - PlusCal}
\begin{lstlisting}[language=pluscal, frame = none, numbers = none]
(**--algorithm LamportMutex {
                    <@\begin{tikzpicture}[overlay, remember picture]
        \node[fill=white, rectangle callout, rounded corners, callout absolute pointer={(pic cs:aux)}, draw, align=left] at ([yshift=0cm,xshift=4cm]pic cs:aux){Process executing\\ the main algorithm};
        \end{tikzpicture}
       @>
process (proc \in Proc) {
 ncs: while (TRUE) {
      \* non-critical section
 try: \* multicast a message requesting access to cs
 enter: \* wait for acknowledgements 
 cs: \* critical section
 exit: \* multicast the release message
 } \* end while
} \* end process
\end{lstlisting}
\end{exampleblock}
\end{frame}

\begin{frame}[fragile]{Process modelisation (in Distributed PlusCal)}
        \begin{exampleblock}{Lamport Mutex Example - PlusCal}
        \begin{lstlisting}[language=pluscal, frame = none, numbers = none]
        
process (comm \in Comm) {<@\begin{tikzpicture}[overlay, remember picture]
        \node[fill=white, rectangle callout, rounded corners, callout absolute pointer={(pic cs:aux)}, draw, align=left] at ([yshift=0.5cm,xshift=2cm]pic cs:aux){Process handling\\ messages};
        \end{tikzpicture}
       @>
                    
 rcv: while (TRUE) {
       with (prc = node(self),
         ...) {
        \* handle request, acknowledge and release messages
       }
     } \* end while
} \* end process
\end{lstlisting}
\end{exampleblock}
\end{frame}

\begin{frame}[fragile]{Process modelisation (in Distributed PlusCal)}
\begin{exampleblock}{Lamport Mutex Example - PlusCal}
        \begin{lstlisting}[language=pluscal, frame = none, numbers = none]
process (comm \in Comm) {
 rcv: while (TRUE) {
       with (prc = node(self)<@
       \begin{tikzpicture}[overlay, remember picture]
        \node[fill=white, rectangle callout, rounded corners, callout absolute pointer={(pic cs:aux)}, draw, align=left] at ([yshift=1cm,xshift=2cm]pic cs:aux){Proc == 1 .. N \\
        Comm == N+1..N+N \\
        node(c) == c - N};
        \end{tikzpicture}
       @>,
         ...) {
         \* handle request, acknowledge and release messages
       }
     } \* end while
} \* end process
**)
\end{lstlisting}
\end{exampleblock}
\end{frame}


\begin{frame}[fragile]{Lamport Mutex in Distributed PlusCal}
\begin{exampleblock}{Lamport Mutex Example - Distributed PlusCal}
\begin{lstlisting}[language=pluscal, frame = none, numbers = none]
fifos network[Proc, Proc];
process(p \in Proc)
     variables ..
{                    <@\begin{tikzpicture}[overlay, remember picture]
        \node[fill=white, rectangle callout, rounded corners, callout absolute pointer={(pic cs:aux)}, draw, align=left] at ([yshift=1cm,xshift=3cm]pic cs:aux){sub-process executing\\ the main algorithm};
        \end{tikzpicture}
       @>
     ncs: \*non-critical section
     .. 
     exit: \* multicast the
           \* release message 
}  {
                                <@\begin{tikzpicture}[overlay, remember picture]
        \node[fill=white, rectangle callout, rounded corners, callout absolute pointer={(pic cs:aux)}, draw, align=left] at ([yshift=1cm,xshift=2cm]pic cs:aux){message handling \\ sub-process};
        \end{tikzpicture}
       @>
    rcv: \* receive msg from channel
         \* handle request, acknowledge and release messages
} \* end message handling thread
**)
\end{lstlisting}
\end{exampleblock}
\end{frame}

\begin{frame}[fragile]{Channels modelisation}

\begin{columns}
\begin{column}{0.52\textwidth}
\begin{exampleblock}{Declaration (in PlusCal)}
        \begin{lstlisting}[language=pluscal, frame = none, numbers = none]
network=[p,q \in Proc |-> <@$\seq{}$@>] 
\end{lstlisting}
\end{exampleblock}
\end{column}
\pause

\begin{column}{0.57\textwidth}
\begin{exampleblock}{Declaration (in Distrbuted PlusCal)}
 \begin{lstlisting}[language=pluscal, frame = none, numbers = none]
fifos network[Proc, Proc];\end{lstlisting}
\end{exampleblock}
\end{column}
\pause
\end{columns}

\begin{columns}
\begin{column}{0.5\textwidth}
\begin{exampleblock}{Operation (in PlusCal)}
        \begin{lstlisting}[language=pluscal, frame = none, numbers = none]
macro mcast(p, msg) {
 network := [s,d \in Proc |-> IF s = p /\ d # p THEN Append(network[s,d], msg) ELSE network[s,d]]
}
mcast(self, Request(clock));l\end{lstlisting}
\end{exampleblock}
\end{column}
\pause

\begin{column}{0.57\textwidth}
\begin{exampleblock}{Operation (in Distrbuted PlusCal)}
 \begin{lstlisting}[language=pluscal, frame = none, numbers = none]
 \*  the 1st argument is the channel name and the 2nd is a TLA+ expression that specifies the message and the intended recipients
 
multicast(network, [self, p \in Proc |-> Request(clock)]);

\end{lstlisting}
\newline

\end{exampleblock}
\end{column}
\end{columns}
\end{frame}



\begin{frame}[fragile]{General Structure of an algorithm}
\begin{lstlisting}[language=pluscal, frame = tlrb, numbers = none]
(* --algorithm <<@\textcolor{black}{algorithm}@> name>
(* Declaration section *)
variables <variable declarations>
channels <channel declarations>
fifos <fifo declarations>
(* ... *)
(* Processes section *)
process (<name> [=|\in] <Expr>))
  variables <variable declarations>
  <subprocesses>
*)
\end{lstlisting}
\end{frame}

\section{Distributed PlusCal Features}

\subsection{Communication Channels}

\begin{frame}[fragile]{Operation on channels}
    \begin{itemize}
     \item Supported operators 
            \begin{itemize}
                \item \verb|send(ch, el)|
                \item \verb|receive(ch, var)|
                \item \verb|broadcast(ch, [x \in S \mapsto e(x)]| 
                \item \verb|multicast(ch, [x \in S \mapsto e(x)]|
                \item \verb|clear(ch)|
            \end{itemize}

    \end{itemize}
\end{frame}

\begin{frame}[fragile]{Unordered Channels Translation}
        \[
            \keyword{channel}\ \entity{id}[\entity{Expr_1},\dots,\entity{Expr_N}];
        \]
    \begin{itemize}

     \item Translation based on \tlaplus sets
     \newline
        \begin{itemize}
            \item \verb|send(chan[e], msg)| $\triangleq$
            \verb|chan' = [chan EXCEPT ![e] = chan[e] \cup {msg}]| 
            \newline
            \item \verb|receive(chan[e], var)| $\triangleq$
                  \verb|\E temp \in chan[e]:| \newline \tab\tab\tab\tab
                     \verb|  /\ var' = temp|\newline \tab\tab\tab\tab
                     \verb|  /\ chan' = [chan EXCEPT ![e]|
                     \tab\tab\tab\tab\tab\tab\verb|   = chan[e] \ {temp}]|
        \end{itemize}

    \end{itemize}
\end{frame}

\begin{frame}[fragile]{FIFO Channels Translation}

        \[
            \keyword{fifo}\ \entity{id}[\entity{Expr_1},\dots,\entity{Expr_N}];
        \]
    \begin{itemize}    
     \item Translation based on \tlaplus sequences
     \newline
            \begin{itemize}
                \item \verb|send(chan[e], msg)| $\triangleq$
                \verb|chan' = [chan EXCEPT ![e] = Append(@, msg)]| 
                \newline
                \item \verb|receive(chan[e], var)| $\triangleq$
                      \verb| /\ Len(chan[e]) > 0 | \newline \tab\tab\tab\tab
                         \verb|/\ var' = [Head(chan[e])]|\newline \tab\tab\tab\tab
                         \verb|/\ chan' = [chan EXCEPT ![e]|
                         \tab\tab\tab\tab\tab\tab\verb| = Tail(@) ]|
            \end{itemize}
    \end{itemize}
\end{frame}

\subsection{Program counter}

\begin{frame}[fragile]{Program counter}
    \begin{itemize}
     \item The special variable $pc$ was modified to take into account sub-processes

\[
pc = [self \in ProcSet \mapsto [self \in IdSet \mapsto \seq{"lbl",\dots}]]
\]	

    where \verb|IdSet| is a collection that contains process identifiers, and the labels that appear in the sequence are the entry point actions for each sub-process

    \end{itemize}
\end{frame}

\begin{frame}[fragile]{Translation to \tlaplus}
 \begin{lstlisting}[language=pluscal, frame = tlrb, numbers=none]  
 exit:  
    clock := clock + 1;
    multicast(network, [self, p \in Proc \ {self} |->
                              Release(clock)]);
\end{lstlisting}


\begin{lstlisting}[language=pluscal, frame = tlrb, numbers=none]  
exit(self) == 
    /\ pc[self]%[1]% = "exit"
    /\ clock' = [clock <@\textcolor{violet}{EXCEPT}@> ![self] = clock[self] + 1]
    %/\ network' = [<<slf, n>> \in <@\textcolor{violet}{DOMAIN}@> network |->
        <@\textcolor{violet}{IF}@> 
            slf = self /\ p \in Proc \ { self } 
        <@\textcolor{violet}{THEN}@> 
            Append(network[slf, p], Release(clock'[self])) 
        <@\textcolor{violet}{ELSE}@>
            network[slf, p]]%
    /\ pc' = [pc <@\textcolor{violet}{EXCEPT}@> ![self]%[1]% = "ncs"]
    /\ <@\textcolor{violet}{UNCHANGED}@> << req, ack, sndr, msg >>
\end{lstlisting}
\end{frame}



\begin{frame}{Contributions and future work}
\begin{block}{Contributions}
\begin{itemize}
    \item An extension of PlusCal offering the possibility to define
        \begin{itemize}
            \item Sub-Processes
            \item Communication Channels
        \end{itemize}

    \item A backward compatible translator to \tlaplus

\end{itemize}
\end{block}
\begin{block}{Future Work}
In the future we aim to introduce more types of communication channels and channel operators.
\end{block}

\end{frame}

\end{document}